<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Review & Edit JD</title>
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f7fa;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    header {
      position: sticky;
      top: 0;
      background: #f5f7fa;
      width: 100%;
      padding: 10px 0;
      text-align: center;
      z-index: 10;
    }

    h1 {
      margin: 0;
      font-size: 24px;
      color: #333;
    }

    #editor-wrapper {
      width: 100%;
      max-width: 800px;
      background: #fff;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    #editor-container {
      min-height: 400px;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px;
    }

    #controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    #submit-btn {
      padding: 12px 24px;
      font-size: 16px;
      background: #4CAF50;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    #submit-btn:hover {
      background: #45a049;
    }

    #char-count {
      font-size: 14px;
      color: #555;
    }

    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #323232;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      display: none;
      z-index: 999;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 20px;
      }

      #submit-btn {
        width: 100%;
      }

      #controls {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>

  <header><h1>Review & Edit Job Description</h1></header>

  <div id="editor-wrapper">
    <div id="editor-container"></div>
    <div id="controls">
      <span id="char-count">Characters: 0</span>
      <button type="button" id="submit-btn">Submit Final JD</button>
    </div>
  </div>

  <div id="toast"></div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <script>
    const quill = new Quill('#editor-container', { theme: 'snow' });
    const charCount = document.getElementById('char-count');
    const toast = document.getElementById('toast');

    function showToast(message, success = true) {
      toast.textContent = message;
      toast.style.background = success ? '#4CAF50' : '#d9534f';
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }

    function updateCharCount() {
      const text = quill.getText().trim();
      charCount.textContent = `Characters: ${text.length}`;
    }

    quill.on('text-change', updateCharCount);
    updateCharCount();

    const params = new URLSearchParams(window.location.search);
    const base64JD = params.get('jd');
    if (base64JD) {
      try {
        quill.root.innerHTML = atob(base64JD);
        updateCharCount();
      } catch (err) {
        quill.root.innerHTML = '<p><em>Invalid JD content.</em></p>';
        console.error('Error decoding JD:', err);
      }
    } else {
      quill.root.innerHTML = '<p><em>No JD content provided.</em></p>';
    }

    document.getElementById('submit-btn').addEventListener('click', async () => {
      const jdHtml = quill.root.innerHTML;
      const payload = { finalizedJD: jdHtml };

      const button = document.getElementById('submit-btn');
      button.disabled = true;
      button.textContent = 'Submitting...';

      try {
        const [whatsRes, linkedRes, teleRes] = await Promise.all([
          fetch('https://n8n.sapidblue.in/webhook/whatsapp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          }),
          fetch('https://n8n.sapidblue.in/webhook/linkedin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          }),
          fetch('https://n8n.sapidblue.in/webhook/telegram', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          }),
        ]);

        if (whatsRes.ok && linkedRes.ok && teleRes.ok) {
          const [whatsapp, linkedin, telegram] = await Promise.all([
            whatsRes.json(),
            linkedRes.json(),
            teleRes.json(),
          ]);

          const formatted = {
            whatsapp: whatsapp.message || 'No WhatsApp content',
            linkedin: linkedin.message || 'No LinkedIn content',
            telegram: telegram.message || 'No Telegram content',
          };

          const encoded = btoa(JSON.stringify(formatted));
          window.location.href = `result.html?data=${encoded}`;
        } else {
          showToast('❌ One or more submissions failed', false);
        }
      } catch (error) {
        showToast(`⚠️ Error: ${error.message}`, false);
        console.error('Error submitting JD:', error);
      } finally {
        button.disabled = false;
        button.textContent = 'Submit Final JD';
      }
    });
  </script>

</body>
</html>
